{% extends 'base.html' %}

{% block title %}Apply for Metering - Al Muslim Engineers{% endblock %}

{% block content %}
<section class="form-section">
    <div class="form-bg">
        <img src="{{ url_for('static', filename='images/project-2.jpg') }}" alt="Solar Farm">
        <div class="form-overlay"></div>
    </div>
    
    <div class="form-container">
        <div class="form-card form-card-large">
            <div class="form-header">
                <div class="form-icon">
                    <i class="fas fa-solar-panel"></i>
                </div>
                <h1>Apply for Metering</h1>
                <p>Submit your net or gross metering application</p>
            </div>
            
            <div class="metering-info">
                <div class="info-card">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Important Information:</strong>
                        <ul>
                            <li>Net Metering: Available for systems <strong>5kW and above</strong></li>
                            <li>Gross Metering: Available for systems <strong>1kW to 50kW</strong></li>
                            <li>Service Area: <strong>Rawalpindi Only</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <form class="application-form" method="POST" action="{{ url_for('apply_metering') }}">
                <div class="form-section-title">
                    <i class="fas fa-list-alt"></i> Application Details
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="application_type">
                            <i class="fas fa-exchange-alt"></i> Application Type <span class="required">*</span>
                        </label>
                        <select id="application_type" name="application_type" required onchange="updateCapacityLimits()">
                            <option value="">Select Type</option>
                            <option value="net">Net Metering (Export to Grid)</option>
                            <option value="gross">Gross Metering (Sell All to Grid)</option>
                        </select>
                        <small class="form-hint" id="typeHint"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="system_capacity">
                            <i class="fas fa-bolt"></i> System Capacity (kW) <span class="required">*</span>
                        </label>
                        <input type="number" id="system_capacity" name="system_capacity" 
                               min="1" max="50" step="0.1" required
                               placeholder="Enter capacity (1-50 kW)">
                        <small class="form-hint" id="capacityHint">Range: 1kW - 50kW</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="consumption_units">
                            <i class="fas fa-chart-bar"></i> Monthly Consumption (Units)
                        </label>
                        <input type="number" id="consumption_units" name="consumption_units" 
                               placeholder="Average monthly units">
                        <small class="form-hint">Helps us recommend optimal system size</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="property_type">
                            <i class="fas fa-building"></i> Property Type <span class="required">*</span>
                        </label>
                        <select id="property_type" name="property_type" required>
                            <option value="">Select Type</option>
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="industrial">Industrial</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section-title">
                    <i class="fas fa-map-marker-alt"></i> Property Location
                </div>
                
                <div class="form-group">
                    <label for="property_address">
                        <i class="fas fa-home"></i> Property Address <span class="required">*</span>
                    </label>
                    <textarea id="property_address" name="property_address" rows="3" required
                              placeholder="Enter complete address in Rawalpindi"></textarea>
                    <small class="form-hint">Please provide detailed address including sector/area</small>
                </div>
                
                <div class="form-section-title">
                    <i class="fas fa-calculator"></i> Cost Estimation
                </div>
                
                <div class="cost-estimate" id="costEstimate">
                    <div class="estimate-row">
                        <span>Estimated System Cost:</span>
                        <strong id="estimatedCost">PKR 0</strong>
                    </div>
                    <div class="estimate-row">
                        <span>Estimated Annual Savings:</span>
                        <strong id="estimatedSavings">PKR 0</strong>
                    </div>
                    <div class="estimate-note">
                        <i class="fas fa-info-circle"></i> Final cost may vary based on site survey
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large">
                        <i class="fas fa-paper-plane"></i> Submit Application
                    </button>
                    <a href="{{ url_for('client_dashboard') }}" class="btn btn-outline">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    function updateCapacityLimits() {
        const type = document.getElementById('application_type').value;
        const capacityInput = document.getElementById('system_capacity');
        const typeHint = document.getElementById('typeHint');
        const capacityHint = document.getElementById('capacityHint');
        
        if (type === 'net') {
            capacityInput.min = 5;
            typeHint.textContent = 'Net metering requires minimum 5kW system';
            typeHint.style.color = 'var(--warning-color)';
            capacityHint.textContent = 'Range: 5kW - 50kW';
        } else if (type === 'gross') {
            capacityInput.min = 1;
            typeHint.textContent = 'Gross metering available for 1kW - 50kW systems';
            typeHint.style.color = 'var(--success-color)';
            capacityHint.textContent = 'Range: 1kW - 50kW';
        } else {
            typeHint.textContent = '';
            capacityHint.textContent = 'Range: 1kW - 50kW';
        }
        
        updateCostEstimate();
    }
    
    function updateCostEstimate() {
        const capacity = parseFloat(document.getElementById('system_capacity').value) || 0;
        const costPerKw = 80000; // PKR per kW
        
        if (capacity > 0 && capacity <= 50) {
            const totalCost = capacity * costPerKw;
            const annualSavings = capacity * 60000; // Approximate annual savings
            
            document.getElementById('estimatedCost').textContent = 'PKR ' + totalCost.toLocaleString();
            document.getElementById('estimatedSavings').textContent = 'PKR ' + annualSavings.toLocaleString();
        } else {
            document.getElementById('estimatedCost').textContent = 'PKR 0';
            document.getElementById('estimatedSavings').textContent = 'PKR 0';
        }
    }
    
    document.getElementById('system_capacity').addEventListener('input', updateCostEstimate);
    
    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const type = document.getElementById('application_type').value;
        const capacity = parseFloat(document.getElementById('system_capacity').value);
        
        if (type === 'net' && capacity < 5) {
            e.preventDefault();
            alert('Net metering requires a minimum system capacity of 5kW');
            return false;
        }
        
        if (capacity < 1 || capacity > 50) {
            e.preventDefault();
            alert('System capacity must be between 1kW and 50kW');
            return false;
        }
    });
</script>
{% endblock %}
